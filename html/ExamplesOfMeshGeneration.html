
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Generating FE meshes from with &Uacute;a</title><meta name="generator" content="MATLAB 9.6"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2019-06-08"><meta name="DC.source" content="ExamplesOfMeshGeneration.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Generating FE meshes from with &Uacute;a</h1><!--introduction--><p>Several examples of how to define meshes</p><p>Note that when using &Uacute;a, the call to genmesh2d is not needed as this call is done from within &Uacute;a Also the call CtrlVar=Ua2D_DefaultParameters() is not needed either.</p><p>To run individual examples you can use the matlab option of running code sections from within editor. See: 'doc run code sections' Just click on some part of the code using the mouse, the text will be highligted in yellow, then press ctrl ret</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Example: A simple polygon</a></li><li><a href="#2">Example: periodic boundary conditions</a></li><li><a href="#3">Example: sinusoidal bed</a></li><li><a href="#4">Example: ice dome</a></li><li><a href="#5">Example:  house without a window</a></li><li><a href="#6">Example: A house with a window! :-)</a></li><li><a href="#7">Example: A house with a tree</a></li><li><a href="#8">Example: A house with windows and a tree :-)</a></li><li><a href="#9">Example: Mesh with several holes and islands</a></li><li><a href="#10">Example: an elliptical hole/crack</a></li><li><a href="#11">Example: Constrainted meshing with two joined meshes sharing the same boundary</a></li><li><a href="#12">Example: two separate meshes in contact</a></li><li><a href="#13">Example: Internal boundaries</a></li><li><a href="#14">Example: Two subdomains sharing a common boundary.</a></li><li><a href="#15">Example: Several different subdomains</a></li><li><a href="#16">Example: Meshing the Brunt Ice Shelf</a></li><li><a href="#18">Example: Meshing the Brunt Ice Shelf with an internal boundary and a `fill-in'</a></li></ul></div><h2 id="1">Example: A simple polygon</h2><p>mesh boundary coordinates should go clockwise around the domain (although if this is done incorrectly, &Uacute;a will automatically correct for this anyhow.)</p><pre class="codeinput">UserVar=[];
CtrlVar=Ua2D_DefaultParameters(); <span class="comment">%</span>
<span class="comment">% Note; When creating this mesh using &Uacute;a, only the following</span>
<span class="comment">% three lines are required in the Ua2D_InitialUserInput.m</span>
CtrlVar.MeshSizeMax=0.1;
CtrlVar.MeshSizeMin=0.1;
CtrlVar.MeshSize=0.1;
MeshBoundaryCoordinates=[-1 -1 ; -1 0 ; 0 1 ; 1 0 ; 1 -1 ; 0 0];
CtrlVar.MeshBoundaryCoordinates=MeshBoundaryCoordinates;
<span class="comment">% Now generate mesh (When using &Uacute;a this is done internally, no such call</span>
<span class="comment">% then needed).</span>

[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates);
figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)
hold <span class="string">on</span>
CtrlVar.MeshBoundaryCoordinates=MeshBoundaryCoordinates;
GmshPointsInLoop=PlotGmshGeometryDefinition(CtrlVar);
drawnow
<span class="comment">%str=input('Next example? y/n [y] ? ','s');  if strcmpi(str,'n') ; return ; end</span>
</pre><h2 id="2">Example: periodic boundary conditions</h2><pre class="codeinput">CtrlVar=Ua2D_DefaultParameters();
UserVar=[];
<span class="comment">% When using &Uacute;a only the following lines are needed in the input file</span>
<span class="comment">% Ua2D_InitialUserInput.m</span>
L=5e3 ; H=1e3;
CtrlVar.MeshSizeMax=H/5;
CtrlVar.MeshSize=CtrlVar.MeshSizeMax;
CtrlVar.MeshSizeMin=CtrlVar.MeshSizeMax/5;
MeshBoundaryCoordinates=[0 0 ; 0 H ; L H ; L 0];
<span class="comment">% If we want to use periodic boundary conditions then we must make sure that the</span>
<span class="comment">% mesh has the same periodic properties.</span>
<span class="comment">% These lines are added to the gmsh .geo input file each time such a file is</span>
<span class="comment">% created. This is a direct input to gmsh and must be on a correct from. The</span>
<span class="comment">% gmsh manual (http://gmsh.info/doc/texinfo/gmsh.html) gives a good description.</span>
<span class="comment">% `CtrlVar.GmshGeoFileAdditionalInputLines' is a cell array with each element of</span>
<span class="comment">% that array being a string. This is added to the gmsh input file. This allows</span>
<span class="comment">% for any additional inputs to gmsh to be specified.</span>
CtrlVar.GmshGeoFileAdditionalInputLines{1}=<span class="string">'Physical Line(1) = {1};'</span>;
CtrlVar.GmshGeoFileAdditionalInputLines{2}=<span class="string">'Physical Line(2) = {2};'</span>;
CtrlVar.GmshGeoFileAdditionalInputLines{3}=<span class="string">'Physical Line(3) = {3};'</span>;
CtrlVar.GmshGeoFileAdditionalInputLines{4}=<span class="string">'Physical Line(4) = {4};'</span>;
CtrlVar.GmshGeoFileAdditionalInputLines{5}=<span class="string">'Physical Surface(1) = {1};'</span>;
CtrlVar.GmshGeoFileAdditionalInputLines{6}=<span class="string">'Periodic Line {1,2} = {3,4};'</span>;
<span class="comment">% Now everything needed for mesh generation has been defined. If we are running</span>
<span class="comment">% &Uacute;a this is all we need to do. But to see the resulting mesh we now</span>
<span class="comment">% generate the mesh in the exact same way as &Uacute;a would do, i.e. through a call to</span>
<span class="comment">% 'genmesh2d'.</span>
UserVar=[];
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates);
figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)

CtrlVar.MeshBoundaryCoordinates=MeshBoundaryCoordinates;
GmshPointsInLoop=PlotGmshGeometryDefinition(CtrlVar);
drawnow

<span class="comment">%str=input('Next example? y/n [y] ? ','s');  if strcmpi(str,'n') ; return ; end</span>
</pre><h2 id="3">Example: sinusoidal bed</h2><pre class="codeinput">CtrlVar=Ua2D_DefaultParameters();
UserVar=[];
xL=-20e3 ; xR=20e3 ; yB=0 ; yT=2e3;
lambda=(xR-xL)/2; Ampl=1e3 ;
CtrlVar.MeshSize=0.5e3;
CtrlVar.MeshSizeMin=CtrlVar.MeshSize/5;
CtrlVar.MeshSizeMax=5*CtrlVar.MeshSize;
<span class="comment">%</span>
CtrlVar.GmshCharacteristicLengthExtendFromBoundary=1;
CtrlVar.GmshCharacteristicLengthFromCurvature = 1 ;

xbed=xL:CtrlVar.MeshSize:xR;
ybed=Ampl*sin(2*pi*xbed/lambda)+  yB;
xbed=xbed(:) ; ybed=ybed(:);

MeshBoundaryCoordinates=[xR yB ; xR yT ; xL yT ; xL yB ; xbed(2:end-1) ybed(2:end-1) ];
N=length(xbed)+2;
<span class="comment">% these lines are added to the gmsh .geo input file each time such a file is created</span>
CtrlVar.GmshGeoFileAdditionalInputLines{1}=<span class="string">'Periodic Line {1} = {3};'</span>;
CtrlVar.GmshGeoFileAdditionalInputLines{2}=<span class="string">'Physical Line(0) = {1};'</span>;
CtrlVar.GmshGeoFileAdditionalInputLines{3}=<span class="string">'Physical Line(1) = {2};'</span>;
CtrlVar.GmshGeoFileAdditionalInputLines{4}=<span class="string">'Physical Line(2) = {3};'</span>;
CtrlVar.GmshGeoFileAdditionalInputLines{5}=[<span class="string">'Physical Line(3) = {4:'</span>,num2str(N),<span class="string">'};'</span>];
CtrlVar.GmshGeoFileAdditionalInputLines{6}=<span class="string">'Physical Surface(1) = {1};'</span>;
UserVar=[];
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates);
figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)



CtrlVar.MeshBoundaryCoordinates=MeshBoundaryCoordinates;
GmshPointsInLoop=PlotGmshGeometryDefinition(CtrlVar);
drawnow

<span class="comment">%str=input('Next example? y/n [y] ? ','s'); if strcmpi(str,'n') ; return ; end</span>
</pre><h2 id="4">Example: ice dome</h2><pre class="codeinput">CtrlVar=Ua2D_DefaultParameters();
L=20e3; h0=250;
xL=-L ; xR=L ; yB=0 ;  s0=3e3;

gamm=-s0/L^2;
CtrlVar.MeshSize=1e3;
CtrlVar.MeshSizeMin=0.1e3;
CtrlVar.MeshSizeMax=1e3;

xSurf=xL:CtrlVar.MeshSize:xR;
ySurf=s0+gamm*(abs(xSurf)).^2;
N=numel(xSurf);

<span class="comment">%MeshBoundaryCoordinates=[L 0 ; -L 0 ; xSurf(:) ySurf(:)+100];</span>
MeshBoundaryCoordinates=[xSurf(:) ySurf(:)];
<span class="comment">% these lines are added to the gmsh .geo input file each time such a file is created</span>
CtrlVar.GmshGeoFileAdditionalInputLines{1}=[<span class="string">'Physical Line(1) = {'</span>,num2str(N),<span class="string">'};'</span>];
CtrlVar.GmshGeoFileAdditionalInputLines{2}=<span class="string">'Physical Surface(1) = {1};'</span>;
UserVar=[];

[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates);
figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)
drawnow
<span class="comment">%str=input('Next example? y/n [y] ? ','s'); if strcmpi(str,'n') ; return ; end</span>
</pre><h2 id="5">Example:  house without a window</h2><pre class="codeinput">CtrlVar=Ua2D_DefaultParameters(); CtrlVar.MeshSizeMax=0.1; CtrlVar.MeshSizeMin=0.1; CtrlVar.MeshSize=0.1;
MeshBoundaryCoordinates=[-1 -1 ; -1 0 ; 0 1 ; 1 0 ; 1 -1 ; 0 -1 ] ;
UserVar=[];
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates); figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)
drawnow
<span class="comment">%str=input('Next example? y/n [y] ? ','s'); if strcmpi(str,'n') ; return ; end</span>
</pre><h2 id="6">Example: A house with a window! :-)</h2><p>when creating holes within a mesh, separate boundaries by NaN NaN</p><pre class="codeinput">CtrlVar=Ua2D_DefaultParameters(); CtrlVar.MeshSizeMax=0.1; CtrlVar.MeshSizeMin=0.1; CtrlVar.MeshSize=0.1;
MeshBoundaryCoordinates=[-1 -1 ; -1 0 ; 0 1 ; 1 0 ; 1 -1 ; 0 -1 ; <span class="keyword">...</span><span class="comment">       % Outer boundary (clockwise orientation)</span>
               NaN NaN ;  0.5 -0.5 ; 0.5 0 ; 0.1 0 ; 0.1 -0.5 ; <span class="keyword">...</span><span class="comment">         % inner boundary (anticlockwise orientation)</span>
               NaN NaN ; -0.1 -0.5 ; -0.1 0 ; -0.8 0 ; -0.8 -0.5 ];         <span class="comment">% another innner boundary (anticlockwise orientation)</span>
UserVar=[];
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates); figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)
drawnow
<span class="comment">%str=input('Next example? y/n [y] ? ','s'); if strcmpi(str,'n') ; return ; end</span>
</pre><h2 id="7">Example: A house with a tree</h2><p>When generating separate meshed domains, label each domain with a number. The label is the specified by putting `Label NaN' ahead of the corresponding boundary</p><pre class="codeinput">CtrlVar=Ua2D_DefaultParameters(); CtrlVar.MeshSizeMax=0.1; CtrlVar.MeshSizeMin=0.1; CtrlVar.MeshSize=0.1;
UserVar=[];
MeshBoundaryCoordinates=[1 NaN ; -1 -1 ; -1 0 ; 0 1 ; 1 0 ; 1 -1 ; 0 -1 ; <span class="keyword">...</span><span class="comment">                                                     % boundary of mesh 1</span>
                         2 NaN ; -2.0 -0.5 ; -2.0 0.5 ; -1.5 0.5 ; -1.5 -0.5 ; -1.7 -0.5 ; -1.7 -1 ; -1.8 -1 ; -1.8 -0.5 ];       <span class="comment">% boundary of mesh 2</span>
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates); figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)

drawnow
<span class="comment">%str=input('Next example? y/n [y] ? ','s'); if strcmpi(str,'n') ; return ; end</span>
</pre><h2 id="8">Example: A house with windows and a tree :-)</h2><p>When generating several separate meshed domains with holes, make sure to specify the outer boundary first, then the holes, and indicate to which mesh a given boundary belongs</p><pre class="codeinput">CtrlVar=Ua2D_DefaultParameters(); CtrlVar.MeshSizeMax=0.1; CtrlVar.MeshSizeMin=0.1; CtrlVar.MeshSize=0.1;
UserVar=[];
MeshBoundaryCoordinates=[1 NaN ; -1 -1 ; -1 0 ; 0 1 ; 1 0 ; 1 -1 ; 0 -1 ; <span class="keyword">...</span><span class="comment">      % outer boundary of mesh 1 (clockwise)</span>
    1 NaN ; 0.5 -0.5 ; 0.5 0 ; 0.1 0 ; 0.1 -0.5 ; <span class="keyword">...</span><span class="comment">                              % a hole within mesh 1     (anticlockwise)</span>
    1 NaN ; -0.1 -0.5 ; -0.1 0 ; -0.8 0 ; -0.8 -0.5 ; <span class="keyword">...</span><span class="comment">                          % a further hole within mesh 1 (anticlockwise)</span>
    3 NaN ; -2.0 -0.5 ; -2.0 0.5 ; -1.5 0.5 ; -1.5 -0.5 ; -1.7 -0.5 ; -1.7 -1 ; -1.8 -1 ; -1.8 -0.5 ];   <span class="comment">% another mesh (clockwise). mesh labels do not need to be in sequential order</span>
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates); figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)
drawnow
<span class="comment">%str=input('Next example? y/n [y] ? ','s'); if strcmpi(str,'n') ; return ; end</span>
</pre><h2 id="9">Example: Mesh with several holes and islands</h2><pre class="codeinput">CtrlVar=Ua2D_DefaultParameters();
CtrlVar.MeshSizeMax=0.1; CtrlVar.MeshSize=0.1;
CtrlVar.MeshSizeMin=0.1; CtrlVar.TriNodes=10 ;
MeshBoundaryCoordinates=<span class="keyword">...</span>
    [1 NaN ; -1 -1 ; -1 0 ; 0 1 ; 1 0 ; 1 -1 ; 0 -1 ; <span class="keyword">...</span><span class="comment">     % outer boundary of mesh 1</span>
    1 NaN ; 0.5 -0.5 ; 0.5 0 ; 0.1 0 ; 0.1 -0.5 ; <span class="keyword">...</span><span class="comment">         % inner boundary of mesh 1</span>
    1 NaN ; -0.1 -0.5 ; -0.1 0 ; -0.8 0 ; -0.8 -0.5 ; <span class="keyword">...</span><span class="comment">     % another inner boundary of mesh 1</span>
    2 NaN ; -0.7 -0.4 ; -0.7 -0.1 ; -0.2 -0.1 ; -0.2 -0.4 ; <span class="keyword">...</span><span class="comment">   % outer boundary of mesh 2</span>
    40 NaN ; -3.0 -1.0 ; -3.0  0.5 ; -1.5 0.5 ; -1.5 -1.0 ;<span class="keyword">...</span><span class="comment">    % outer boundary of mesh 40</span>
    40 NaN ; -2.8 -0.8 ; -1.8 -0.8 ; -1.8 0.4 ; -2.8  0.4 ; <span class="keyword">...</span><span class="comment">   % inner boundary of mesh 40</span>
    50 NaN ; -2.6 -0.6 ; -2.6 0.3 ; -2.0 0.3 ; -2.0 -0.6  ; <span class="keyword">...</span><span class="comment">   % outer boundary of mesh 50</span>
    50 NaN ; -2.5 -0.5 ; -2.1 -0.5 ; -2.1 0.1 ; -2.5 0.1 ];       <span class="comment">% inner boundary of mesh 50</span>

CtrlVar.GmshMeshingAlgorithm=8;    <span class="comment">% see gmsh manual</span>

UserVar=[];
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates); figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)

<span class="comment">% also calculate and plot normals</span>
[nx,ny,xn,yn,Nx,Ny] = CalcEdgeAndNodalNormals(MUA.connectivity,MUA.coordinates,MUA.Boundary.Edges);
QuiverColorGHG(MUA.coordinates(MUA.Boundary.Nodes,1),MUA.coordinates(MUA.Boundary.Nodes,2),<span class="keyword">...</span>
     Nx(MUA.Boundary.Nodes),Ny(MUA.Boundary.Nodes),[]);

CtrlVar.MeshBoundaryCoordinates=MeshBoundaryCoordinates;
GmshPointsInLoop=PlotGmshGeometryDefinition(CtrlVar);

drawnow

 <span class="comment">%str=input('Next example? y/n [y] ? ','s'); if strcmpi(str,'n') ; return ; end</span>
</pre><h2 id="10">Example: an elliptical hole/crack</h2><p>when creating holes within a mesh, separate boundaries by NaN NaN</p><pre class="codeinput">CtrlVar=Ua2D_DefaultParameters();
CtrlVar.MeshSizeMax=1e3;
CtrlVar.MeshSize=1e3;
CtrlVar.MeshSizeMin=0.1e3;


a=0.1e3; <span class="comment">% horizontal radius</span>
b=5e3; <span class="comment">% vertical radius</span>
x0=0; <span class="comment">% x0,y0 ellipse centre coordinates</span>
y0=0;
t=linspace(-pi,pi,200);  t(end)=[];
xe=x0+a*cos(t);
ye=y0+b*sin(t);

CtrlVar.GmshCharacteristicLengthFromCurvature = 1 ;
CtrlVar.GmshCharacteristicLengthExtendFromBoundary=1;


MeshBoundaryCoordinates=<span class="keyword">...</span>
    [-10e3 -10e3 ; <span class="keyword">...</span>
    -10e3 10e3 ; <span class="keyword">...</span>
    10e3 10e3 ; <span class="keyword">...</span>
    10e3 -10e3 ; <span class="keyword">...</span>
    NaN  NaN ; <span class="keyword">...</span>
     xe(:) ye(:)] ;

UserVar=[];
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates);
figure ;
PlotFEmesh(MUA.coordinates,MUA.connectivity)
CtrlVar.MeshBoundaryCoordinates=MeshBoundaryCoordinates;
GmshPointsInLoop=PlotGmshGeometryDefinition(CtrlVar);
drawnow
</pre><h2 id="11">Example: Constrainted meshing with two joined meshes sharing the same boundary</h2><p>Since here the same line belongs to more then one mesh we need to specify the 'plane surface' (gmsh terminology) separatly. This is done in CtrlVar.GmshPlaneSurface</p><pre class="codeinput">CtrlVar=Ua2D_DefaultParameters(); CtrlVar.MeshSizeMax=0.1; CtrlVar.MeshSizeMin=0.1; CtrlVar.MeshSize=0.1;
CtrlVar.MeshGenerator=<span class="string">'gmsh'</span>;
CtrlVar.MeshGenerator=<span class="string">'mesh2d'</span>;
UserVar=[];
MeshBoundaryCoordinates=[1 NaN ;-1 -1 ; -1 0 ; 0 1 ; 1 0 ; 1 -1 ; 0 -1 ; <span class="keyword">...</span><span class="comment">       % Outer boundary (clockwise orientation)</span>
                         1 NaN ;  0.5 -0.5 ; 0.5 0 ; 0.1 0 ; 0.1 -0.5 ; <span class="keyword">...</span><span class="comment">         % inner boundary (anticlockwise orientation)</span>
                         1 NaN ; -0.1 -0.5 ; 0 0.3 ; -0.95 0 ; -0.8 -0.9 ];         <span class="comment">% another innner boundary (anticlockwise orientation)</span>

CtrlVar.GmshPlaneSurface{1}=[1 2 3]; <span class="comment">% mesh 1 is defined by boundaries 1, 2 and 3</span>
CtrlVar.GmshPlaneSurface{2}=[-2];  <span class="comment">% mesh 2 is defined by boundary 2, make sure to use a negative sign to indicate a reverse ordering</span>
CtrlVar.GmshPlaneSurface{3}=[-3];  <span class="comment">% mesh 2 is defined by boundary 2, make sure to use a negative sign to indicate a reverse ordering</span>
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates); figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)

plot(MeshBoundaryCoordinates(:,1),MeshBoundaryCoordinates(:,2),<span class="string">'-or'</span>,<span class="string">'LineWidth'</span>,2)

drawnow
<span class="comment">%str=input('Next example? y/n [y] ? ','s'); if strcmpi(str,'n') ; return ; end</span>
</pre><h2 id="12">Example: two separate meshes in contact</h2><pre class="codeinput">CtrlVar=Ua2D_DefaultParameters(); CtrlVar.MeshSizeMax=0.1; CtrlVar.MeshSizeMin=0.1;  CtrlVar.MeshSize=0.1;
CtrlVar.MeshGenerator=<span class="string">'gmsh'</span>;  <span class="comment">% this option only works with gmsh...</span>
<span class="comment">%CtrlVar.MeshGenerator='mesh2d';</span>
UserVar=[];
MeshBoundaryCoordinates=[1 NaN ;  0 0  ; 0 1 ; 1 1 ; 1 0 ; <span class="keyword">...</span>
                         2 NaN ; -1 0  ; -1 1.001 ; 0 1.001 ; 0 0 ];

[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates); figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)

plot(MeshBoundaryCoordinates(:,1),MeshBoundaryCoordinates(:,2),<span class="string">'-or'</span>,<span class="string">'LineWidth'</span>,2)
drawnow
<span class="comment">%str=input('Next example? y/n [y] ? ','s'); if strcmpi(str,'n') ; return ; end</span>
</pre><h2 id="13">Example: Internal boundaries</h2><pre class="codeinput">CtrlVar.MeshGenerator=<span class="string">'gmsh'</span>;
CtrlVar.MeshGenerator=<span class="string">'mesh2d'</span>;
CtrlVar=Ua2D_DefaultParameters(); CtrlVar.MeshSizeMax=0.1; CtrlVar.MeshSizeMin=0.1;  CtrlVar.MeshSize=0.1;
CtrlVar.GmshInputFormat=1;
UserVar=[];
MeshBoundaryCoordinates=[1 NaN ;  0 0  ; 0 0.25 ; 0.25 0.25 ; 0.25 0.75 ; 0 0.75 ; 0 1 ; 1 1 ; 1 0;   <span class="keyword">...</span>
                         2 NaN ;  0 0.25 ; 0. 0.75 ; 0.25 0.75 ; 0.25 0.25 ];

[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates);
figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)

plot(MeshBoundaryCoordinates(:,1),MeshBoundaryCoordinates(:,2),<span class="string">'-or'</span>,<span class="string">'LineWidth'</span>,2)
drawnow
<span class="comment">%str=input('Next example? y/n [y] ? ','s');  if strcmpi(str,'n') ; return ; end</span>
</pre><h2 id="14">Example: Two subdomains sharing a common boundary.</h2><p>This example uses GmshInputFormat 2.</p><p>Gmsh input format 2 is quite close to the gmsh input format itself and more flexible than the default input format 1, but also more difficult to use.</p><p>The gmsh input format 2 does not use `MeshBoundaryCoordinates' at all.</p><p>Using gmsh input format 2 allows constraint meshing. The computational domain can be split up into several subdomains. each with their own boundaries. One can create internal boundaries within a domain, and subdomains sharing some common boundaries.</p><p>All inputs are defined as fields to the CtrlVar.</p><p>The basic idea is to define points, then to specify lines in terms of those points, loops in terms of those lines, and finally plane surfaces in terms of the loops.</p><pre class="codeinput">CtrlVar=Ua2D_DefaultParameters();
UserVar=[];
CtrlVar.MeshGenerator=<span class="string">'gmsh'</span>;
CtrlVar.GmshInputFormat=2; <span class="comment">% using input format 2</span>
CtrlVar.MeshSizeMax=0.1;
CtrlVar.MeshSizeMin=0.1;
CtrlVar.MeshSize=0.1;

CtrlVar.Gmsh.Points=[0 0 ;<span class="keyword">...</span><span class="comment">    % now define a few gmsh points</span>
                     0 0.5 ; <span class="keyword">...</span><span class="comment"> % although not directly labeled</span>
                     0 1 ;   <span class="keyword">...</span><span class="comment"> % the first point in point 1, etc.</span>
                     1 1 ;  <span class="keyword">...</span>
                     1 0 ; <span class="keyword">...</span>
                     -1 0 ; <span class="keyword">...</span><span class="comment">   % this is point nr 6</span>
                     -1 0.5];     <span class="comment">% and this point nr 7</span>

CtrlVar.Gmsh.Lines{1}=[1 , 2];  <span class="comment">% define gmsh lines using the point labels</span>
CtrlVar.Gmsh.Lines{2}=[2 , 3];
CtrlVar.Gmsh.Lines{3}=[ 3 ; 4 ; 5 ; 1 ];
CtrlVar.Gmsh.Lines{4}=[ 1 ;  6 ; 7 ; 2 ];

CtrlVar.Gmsh.Loops{1}=[1 ; 2 ; 3 ]; <span class="comment">% now define loops</span>
CtrlVar.Gmsh.Loops{2}=[4 ; -1];     <span class="comment">% all loops must be closed!</span>
                                    <span class="comment">% (negative sign reverses the line direction.)</span>

CtrlVar.Gmsh.PlaneSurfaces{1} = [1]; <span class="comment">% finally define the surfaces</span>
CtrlVar.Gmsh.PlaneSurfaces{2} = [2];

MeshBoundaryCoordinates=[]; <span class="comment">% When CtrlVar.GmshInputFormat=2, 'MeshBoundaryCoordinates' are not used</span>
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates);
figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)
hold <span class="string">on</span> ; PlotGmshGeometryDefinition(CtrlVar);
drawnow
<span class="comment">%str=input('Next example? y/n [y] ? ','s');  if strcmpi(str,'n') ; return ; end</span>
</pre><h2 id="15">Example: Several different subdomains</h2><p>This example uses gmsh input format 2</p><pre class="codeinput">CtrlVar=Ua2D_DefaultParameters();
UserVar=[];
MeshBoundaryCoordinates=[];
CtrlVar.MeshGenerator=<span class="string">'gmsh'</span>;
CtrlVar.GmshInputFormat=2;
CtrlVar.MeshSizeMax=0.1; CtrlVar.MeshSizeMin=0.1;  CtrlVar.MeshSize=0.1;
CtrlVar.TriNodes=3;

CtrlVar.Gmsh.Points=[0 0 ;<span class="keyword">...</span>
                     0 0.5 ; <span class="keyword">...</span>
                     0 1 ;   <span class="keyword">...</span>
                     1 1 ;  <span class="keyword">...</span>
                     1 0 ; <span class="keyword">...</span>
                     -1 0 ; <span class="keyword">...</span>
                     -1 0.5 ; <span class="keyword">...</span>
                     0.25 0.25 ; <span class="keyword">...</span>
                     0.35 0.75 ; <span class="keyword">...</span>
                     0.65 0.75 ;
                     0.80 0.25 ;
                     -0.5 1 ; <span class="keyword">...</span>
                     -1 2 ; <span class="keyword">...</span>
                     1 2 ; <span class="keyword">...</span>
                     ];

CtrlVar.Gmsh.Lines{1}=[1 ; 2];
CtrlVar.Gmsh.Lines{2}=[2 ; 3];
CtrlVar.Gmsh.Lines{3}=[ 3 ; 4 ; 5 ; 1 ];
CtrlVar.Gmsh.Lines{4}=[ 1 ;  6 ; 7 ; 2 ];
CtrlVar.Gmsh.Lines{5}=[ 8 ; 9 ; 10 ; 11 ; 8];
CtrlVar.Gmsh.Lines{6}=[ 12 ; 13 ; 14 ; 12];

CtrlVar.Gmsh.Loops{1}=[1 ; 2 ; 3 ];
CtrlVar.Gmsh.Loops{2}=[4 ; -1];
CtrlVar.Gmsh.Loops{3}=[-5]; <span class="comment">% reverse orientation</span>
CtrlVar.Gmsh.Loops{4}=[6];
CtrlVar.Gmsh.Loops{5}=[5];  <span class="comment">%</span>

CtrlVar.Gmsh.PlaneSurfaces{1} = [1 ; 3 ]; <span class="comment">% this surface has a hole</span>
CtrlVar.Gmsh.PlaneSurfaces{2} = [2];
CtrlVar.Gmsh.PlaneSurfaces{3} = [4];
CtrlVar.Gmsh.PlaneSurfaces{4} = [5];


[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates);

<span class="comment">% plotting mesh</span>
figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)
hold <span class="string">on</span>
PlotGmshGeometryDefinition(CtrlVar);

drawnow
<span class="comment">%str=input('Next example? y/n [y] ? ','s');  if strcmpi(str,'n') ; return ; end</span>
</pre><h2 id="16">Example: Meshing the Brunt Ice Shelf</h2><pre class="codeinput">load <span class="string">BruntMeshBoundaryCoordinates.mat</span>
UserVar=[];
I=find(isnan(MeshBoundaryCoordinates(:,1)) | isnan(MeshBoundaryCoordinates(:,2)));

i1a=I(1)+1 ; i1b=I(2)-1;
i2a=I(2)+1 ; i2b=size(MeshBoundaryCoordinates,1);


CtrlVar=Ua2D_DefaultParameters();
CtrlVar.MeshGenerator=<span class="string">'gmsh'</span>;
CtrlVar.MeshGenerator=<span class="string">'mesh2d'</span>;
CtrlVar.GmshInputFormat=2;
CtrlVar.MeshSizeMax=5e3;
CtrlVar.MeshSizeMin=1e3;
CtrlVar.TriNodes=3;


CtrlVar.Gmsh.Points=MeshBoundaryCoordinates(i1a:i1b,:);

CtrlVar.Gmsh.Loops{1}=[1];
CtrlVar.Gmsh.PlaneSurfaces{1} = [1];
CtrlVar.Gmsh.Lines{1}=[(1:i1b-i1a+1)';1];
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates);


<span class="comment">% plotting mesh</span>
figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)
drawnow
<span class="comment">%str=input('Next example? y/n [y] ? ','s');  if strcmpi(str,'n') ; return ; end</span>
</pre><p>Example: Meshing the Brunt Ice Shelf with an internal boundary</p><pre class="codeinput">load <span class="string">BruntMeshBoundaryCoordinates.mat</span>
CtrlVar.Gmsh.Points=[MeshBoundaryCoordinates(i1a:i1b,:); MeshBoundaryCoordinates(i2a:i2b,:) ];
l1a=1 ; l1b=l1a+i1b-i1a;
l2a=l1b+1 ; l2b=l2a+i2b-i2a;
CtrlVar.Gmsh.Lines{1}=[(l1a:l1b)';l1a];
CtrlVar.Gmsh.Lines{2}=[(l2a:l2b)';l2a];
CtrlVar.Gmsh.Loops{1}=[1];
CtrlVar.Gmsh.Loops{2}=[2];
CtrlVar.Gmsh.PlaneSurfaces{1} = [1,-2];
CtrlVar.Gmsh.PlaneSurfaces{2} = [2];

UserVar=[];

[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates);
CtrlVar.Gmsh.Lines{1}=[(1:i1b-i1a+1)';1];

<span class="comment">% plotting mesh</span>
figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)

hold <span class="string">on</span> ; PlotGmshGeometryDefinition(CtrlVar);
drawnow
<span class="comment">%str=input('Next example? y/n [y] ? ','s');  if strcmpi(str,'n') ; return ; end</span>
</pre><h2 id="18">Example: Meshing the Brunt Ice Shelf with an internal boundary and a `fill-in'</h2><pre class="codeinput">load <span class="string">BruntMeshBoundaryCoordinates.mat</span>

I=find(isnan(MeshBoundaryCoordinates(:,1)) | isnan(MeshBoundaryCoordinates(:,2)));

i1a=I(1)+1 ; i1b=I(2)-1;
i2a=I(2)+1 ; i2b=size(MeshBoundaryCoordinates,1);

UserVar=[];
CtrlVar=Ua2D_DefaultParameters();
CtrlVar.GmshInputFormat=2;
CtrlVar.MeshSizeMax=5e3;
CtrlVar.MeshSizeMin=1e3;
CtrlVar.TriNodes=3;
CtrlVar.Gmsh.Points=[MeshBoundaryCoordinates(i1a:i1b,:); MeshBoundaryCoordinates(i2a:i2b,:) ];
l1a=1 ; l1b=l1a+i1b-i1a;
l2a=l1b+1 ; l2b=l2a+i2b-i2a;
CtrlVar.Gmsh.Lines{1}=[(l1a:l1b)';l1a];
CtrlVar.Gmsh.Lines{2}=[(l2a:l2b)';l2a];


Box=[-7.02e+05  -6.4314e+05   1.4651e+06   1.505e+06];
I=CtrlVar.Gmsh.Points(:,1) &gt; Box(1) &amp; CtrlVar.Gmsh.Points(:,1) &lt; Box(2) <span class="keyword">...</span>
    &amp; CtrlVar.Gmsh.Points(:,2) &gt; Box(3) &amp; CtrlVar.Gmsh.Points(:,2) &lt; Box(4) ;

<span class="comment">% now must line 1 into two lines, with one convering the BIS-SW chasm outlines only</span>

x=CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{1},1);
y=CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{1},2);
K=x &gt; Box(1) &amp; x &lt; Box(2) <span class="keyword">...</span>
    &amp; y &gt; Box(3) &amp; y &lt; Box(4) ;

temp=CtrlVar.Gmsh.Lines{1};
temp(K)=NaN; temp(end)=[];
J=find(isnan(temp));
tt=[temp(J(end)+1:end,end);temp(1:J(1)-1)];
CtrlVar.Gmsh.Lines{3}=tt;
CtrlVar.Gmsh.Lines{4}=find(K);
CtrlVar.Gmsh.Lines{4}=[CtrlVar.Gmsh.Lines{3}(end); CtrlVar.Gmsh.Lines{4};CtrlVar.Gmsh.Lines{3}(1)];

CtrlVar.Gmsh.Lines{5}=[CtrlVar.Gmsh.Lines{3}(end);CtrlVar.Gmsh.Lines{3}(1)];
CtrlVar.Gmsh.Lines{6}=[CtrlVar.Gmsh.Lines{4}(end);CtrlVar.Gmsh.Lines{4}(1)];

figure
plot(CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{1},1),CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{1},2),<span class="string">'.-'</span>)
hold <span class="string">on</span>
plot(CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{2},1),CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{2},2),<span class="string">'^-'</span>)
plot(CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{3},1),CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{3},2),<span class="string">'+-'</span>)
hold <span class="string">on</span>
plot(CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{4},1),CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{4},2),<span class="string">'O-'</span>)
plot(CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{5},1),CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{5},2),<span class="string">'*-'</span>)
legend(<span class="string">'1'</span>,<span class="string">'2'</span>,<span class="string">'3'</span>,<span class="string">'4'</span>,<span class="string">'5'</span>)


CtrlVar.Gmsh.Loops{1}=[3,4];
CtrlVar.Gmsh.Loops{2}=[2];
CtrlVar.Gmsh.Loops{3}=[-4,5];

CtrlVar.Gmsh.PlaneSurfaces{1} = [1,-2];
CtrlVar.Gmsh.PlaneSurfaces{2} = [2];
CtrlVar.Gmsh.PlaneSurfaces{3} = [3];


[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates);
CtrlVar.Gmsh.Lines{1}=[(1:i1b-i1a+1)';1];

<span class="comment">% plotting mesh</span>
figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)

hold <span class="string">on</span> ; PlotGmshGeometryDefinition(CtrlVar);
drawnow
<span class="comment">%str=input('Next example? y/n [y] ? ','s');  if strcmpi(str,'n') ; return ; end</span>
<span class="comment">% %% Example of running gmsh directly for a given input file</span>
<span class="comment">%</span>
<span class="comment">% status=system([getenv('GmshHomeDirectory'),'\gmsh.exe GmshFile.geo -2 -v 5']);</span>
<span class="comment">% Gmsh=load_gmshGHG('GmshFile.msh'); % the .msh is a gmsh output file. This file must have be generated previously</span>
<span class="comment">% TRI=Gmsh.TRIANGLES(1:Gmsh.nbTriangles,1:3);</span>
<span class="comment">% xy=Gmsh.POS(1:Gmsh.nbNod,1:2);</span>
<span class="comment">% figure</span>
<span class="comment">% triplot(TRI,xy(:,1),xy(:,2)) ; axis equal</span>
<span class="comment">% drawnow</span>
<span class="comment">% %hold on</span>
<span class="comment">% %plot(MeshBoundaryCoordinates(:,1),MeshBoundaryCoordinates(:,2),'-or','LineWidth',2)</span>
<span class="comment">%</span>
<span class="comment">% %%</span>
</pre><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2019a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Generating FE meshes from with Úa
%
% Several examples of how to define meshes
%
% Note that when using Úa, the call to genmesh2d is not needed as this call is done from within Úa
% Also the call CtrlVar=Ua2D_DefaultParameters() is not needed either.
%
% To run individual examples you can use the matlab option of running code sections from within editor. 
% See: 'doc run code sections'
% Just click on some part of the code using the mouse, the text will be highligted in yellow, then press ctrl ret
%
%% Example: A simple polygon 
% mesh boundary coordinates should go clockwise around the domain
% (although if this is done incorrectly, Úa will automatically correct for this anyhow.)
%
UserVar=[];
CtrlVar=Ua2D_DefaultParameters(); %
% Note; When creating this mesh using Úa, only the following 
% three lines are required in the Ua2D_InitialUserInput.m
CtrlVar.MeshSizeMax=0.1; 
CtrlVar.MeshSizeMin=0.1;
CtrlVar.MeshSize=0.1;
MeshBoundaryCoordinates=[-1 -1 ; -1 0 ; 0 1 ; 1 0 ; 1 -1 ; 0 0];
CtrlVar.MeshBoundaryCoordinates=MeshBoundaryCoordinates;
% Now generate mesh (When using Úa this is done internally, no such call
% then needed).

[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates);
figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)
hold on 
CtrlVar.MeshBoundaryCoordinates=MeshBoundaryCoordinates;
GmshPointsInLoop=PlotGmshGeometryDefinition(CtrlVar);
drawnow
%str=input('Next example? y/n [y] ? ','s');  if strcmpi(str,'n') ; return ; end
%% Example: periodic boundary conditions
CtrlVar=Ua2D_DefaultParameters();
UserVar=[];
% When using Úa only the following lines are needed in the input file
% Ua2D_InitialUserInput.m
L=5e3 ; H=1e3;
CtrlVar.MeshSizeMax=H/5;
CtrlVar.MeshSize=CtrlVar.MeshSizeMax;
CtrlVar.MeshSizeMin=CtrlVar.MeshSizeMax/5;
MeshBoundaryCoordinates=[0 0 ; 0 H ; L H ; L 0];
% If we want to use periodic boundary conditions then we must make sure that the
% mesh has the same periodic properties.
% These lines are added to the gmsh .geo input file each time such a file is
% created. This is a direct input to gmsh and must be on a correct from. The
% gmsh manual (http://gmsh.info/doc/texinfo/gmsh.html) gives a good description. 
% `CtrlVar.GmshGeoFileAdditionalInputLines' is a cell array with each element of
% that array being a string. This is added to the gmsh input file. This allows
% for any additional inputs to gmsh to be specified. 
CtrlVar.GmshGeoFileAdditionalInputLines{1}='Physical Line(1) = {1};';  
CtrlVar.GmshGeoFileAdditionalInputLines{2}='Physical Line(2) = {2};';  
CtrlVar.GmshGeoFileAdditionalInputLines{3}='Physical Line(3) = {3};';  
CtrlVar.GmshGeoFileAdditionalInputLines{4}='Physical Line(4) = {4};';  
CtrlVar.GmshGeoFileAdditionalInputLines{5}='Physical Surface(1) = {1};';  
CtrlVar.GmshGeoFileAdditionalInputLines{6}='Periodic Line {1,2} = {3,4};';
% Now everything needed for mesh generation has been defined. If we are running
% Úa this is all we need to do. But to see the resulting mesh we now
% generate the mesh in the exact same way as Úa would do, i.e. through a call to
% 'genmesh2d'.
UserVar=[];
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates);
figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)

CtrlVar.MeshBoundaryCoordinates=MeshBoundaryCoordinates;
GmshPointsInLoop=PlotGmshGeometryDefinition(CtrlVar);
drawnow

%str=input('Next example? y/n [y] ? ','s');  if strcmpi(str,'n') ; return ; end

%% Example: sinusoidal bed

CtrlVar=Ua2D_DefaultParameters();
UserVar=[];
xL=-20e3 ; xR=20e3 ; yB=0 ; yT=2e3;
lambda=(xR-xL)/2; Ampl=1e3 ;
CtrlVar.MeshSize=0.5e3;
CtrlVar.MeshSizeMin=CtrlVar.MeshSize/5;
CtrlVar.MeshSizeMax=5*CtrlVar.MeshSize;
% 
CtrlVar.GmshCharacteristicLengthExtendFromBoundary=1;
CtrlVar.GmshCharacteristicLengthFromCurvature = 1 ;

xbed=xL:CtrlVar.MeshSize:xR;
ybed=Ampl*sin(2*pi*xbed/lambda)+  yB;
xbed=xbed(:) ; ybed=ybed(:);

MeshBoundaryCoordinates=[xR yB ; xR yT ; xL yT ; xL yB ; xbed(2:end-1) ybed(2:end-1) ]; 
N=length(xbed)+2;
% these lines are added to the gmsh .geo input file each time such a file is created
CtrlVar.GmshGeoFileAdditionalInputLines{1}='Periodic Line {1} = {3};';  
CtrlVar.GmshGeoFileAdditionalInputLines{2}='Physical Line(0) = {1};';  
CtrlVar.GmshGeoFileAdditionalInputLines{3}='Physical Line(1) = {2};';  
CtrlVar.GmshGeoFileAdditionalInputLines{4}='Physical Line(2) = {3};';  
CtrlVar.GmshGeoFileAdditionalInputLines{5}=['Physical Line(3) = {4:',num2str(N),'};'];  
CtrlVar.GmshGeoFileAdditionalInputLines{6}='Physical Surface(1) = {1};';  
UserVar=[];
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates);
figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)



CtrlVar.MeshBoundaryCoordinates=MeshBoundaryCoordinates;
GmshPointsInLoop=PlotGmshGeometryDefinition(CtrlVar);
drawnow

%str=input('Next example? y/n [y] ? ','s'); if strcmpi(str,'n') ; return ; end
%% Example: ice dome


CtrlVar=Ua2D_DefaultParameters();
L=20e3; h0=250;
xL=-L ; xR=L ; yB=0 ;  s0=3e3;

gamm=-s0/L^2;
CtrlVar.MeshSize=1e3;
CtrlVar.MeshSizeMin=0.1e3;
CtrlVar.MeshSizeMax=1e3;

xSurf=xL:CtrlVar.MeshSize:xR;
ySurf=s0+gamm*(abs(xSurf)).^2;
N=numel(xSurf);

%MeshBoundaryCoordinates=[L 0 ; -L 0 ; xSurf(:) ySurf(:)+100]; 
MeshBoundaryCoordinates=[xSurf(:) ySurf(:)]; 
% these lines are added to the gmsh .geo input file each time such a file is created
CtrlVar.GmshGeoFileAdditionalInputLines{1}=['Physical Line(1) = {',num2str(N),'};'];  
CtrlVar.GmshGeoFileAdditionalInputLines{2}='Physical Surface(1) = {1};';  
UserVar=[];

[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates);
figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)
drawnow
%str=input('Next example? y/n [y] ? ','s'); if strcmpi(str,'n') ; return ; end

%% Example:  house without a window
CtrlVar=Ua2D_DefaultParameters(); CtrlVar.MeshSizeMax=0.1; CtrlVar.MeshSizeMin=0.1; CtrlVar.MeshSize=0.1;
MeshBoundaryCoordinates=[-1 -1 ; -1 0 ; 0 1 ; 1 0 ; 1 -1 ; 0 -1 ] ;
UserVar=[];
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates); figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)
drawnow
%str=input('Next example? y/n [y] ? ','s'); if strcmpi(str,'n') ; return ; end
%% Example: A house with a window! :-)
%
% when creating holes within a mesh, separate boundaries by NaN NaN
%
CtrlVar=Ua2D_DefaultParameters(); CtrlVar.MeshSizeMax=0.1; CtrlVar.MeshSizeMin=0.1; CtrlVar.MeshSize=0.1;
MeshBoundaryCoordinates=[-1 -1 ; -1 0 ; 0 1 ; 1 0 ; 1 -1 ; 0 -1 ; ...       % Outer boundary (clockwise orientation)
               NaN NaN ;  0.5 -0.5 ; 0.5 0 ; 0.1 0 ; 0.1 -0.5 ; ...         % inner boundary (anticlockwise orientation)
               NaN NaN ; -0.1 -0.5 ; -0.1 0 ; -0.8 0 ; -0.8 -0.5 ];         % another innner boundary (anticlockwise orientation)
UserVar=[];           
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates); figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)
drawnow
%str=input('Next example? y/n [y] ? ','s'); if strcmpi(str,'n') ; return ; end
%% Example: A house with a tree
%
% When generating separate meshed domains, label each domain with a number.
% The label is the specified by putting `Label NaN' ahead of the corresponding boundary
CtrlVar=Ua2D_DefaultParameters(); CtrlVar.MeshSizeMax=0.1; CtrlVar.MeshSizeMin=0.1; CtrlVar.MeshSize=0.1;
UserVar=[];
MeshBoundaryCoordinates=[1 NaN ; -1 -1 ; -1 0 ; 0 1 ; 1 0 ; 1 -1 ; 0 -1 ; ...                                                     % boundary of mesh 1
                         2 NaN ; -2.0 -0.5 ; -2.0 0.5 ; -1.5 0.5 ; -1.5 -0.5 ; -1.7 -0.5 ; -1.7 -1 ; -1.8 -1 ; -1.8 -0.5 ];       % boundary of mesh 2
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates); figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)

drawnow
%str=input('Next example? y/n [y] ? ','s'); if strcmpi(str,'n') ; return ; end
%% Example: A house with windows and a tree :-)
% When generating several separate meshed domains with holes, make sure
% to specify the outer boundary first, then the holes, and indicate to which mesh a given boundary belongs
CtrlVar=Ua2D_DefaultParameters(); CtrlVar.MeshSizeMax=0.1; CtrlVar.MeshSizeMin=0.1; CtrlVar.MeshSize=0.1;
UserVar=[];
MeshBoundaryCoordinates=[1 NaN ; -1 -1 ; -1 0 ; 0 1 ; 1 0 ; 1 -1 ; 0 -1 ; ...      % outer boundary of mesh 1 (clockwise)
    1 NaN ; 0.5 -0.5 ; 0.5 0 ; 0.1 0 ; 0.1 -0.5 ; ...                              % a hole within mesh 1     (anticlockwise)
    1 NaN ; -0.1 -0.5 ; -0.1 0 ; -0.8 0 ; -0.8 -0.5 ; ...                          % a further hole within mesh 1 (anticlockwise)
    3 NaN ; -2.0 -0.5 ; -2.0 0.5 ; -1.5 0.5 ; -1.5 -0.5 ; -1.7 -0.5 ; -1.7 -1 ; -1.8 -1 ; -1.8 -0.5 ];   % another mesh (clockwise). mesh labels do not need to be in sequential order
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates); figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)
drawnow
%str=input('Next example? y/n [y] ? ','s'); if strcmpi(str,'n') ; return ; end
%% Example: Mesh with several holes and islands
CtrlVar=Ua2D_DefaultParameters(); 
CtrlVar.MeshSizeMax=0.1; CtrlVar.MeshSize=0.1;
CtrlVar.MeshSizeMin=0.1; CtrlVar.TriNodes=10 ;
MeshBoundaryCoordinates=...
    [1 NaN ; -1 -1 ; -1 0 ; 0 1 ; 1 0 ; 1 -1 ; 0 -1 ; ...     % outer boundary of mesh 1
    1 NaN ; 0.5 -0.5 ; 0.5 0 ; 0.1 0 ; 0.1 -0.5 ; ...         % inner boundary of mesh 1
    1 NaN ; -0.1 -0.5 ; -0.1 0 ; -0.8 0 ; -0.8 -0.5 ; ...     % another inner boundary of mesh 1
    2 NaN ; -0.7 -0.4 ; -0.7 -0.1 ; -0.2 -0.1 ; -0.2 -0.4 ; ...   % outer boundary of mesh 2
    40 NaN ; -3.0 -1.0 ; -3.0  0.5 ; -1.5 0.5 ; -1.5 -1.0 ;...    % outer boundary of mesh 40
    40 NaN ; -2.8 -0.8 ; -1.8 -0.8 ; -1.8 0.4 ; -2.8  0.4 ; ...   % inner boundary of mesh 40 
    50 NaN ; -2.6 -0.6 ; -2.6 0.3 ; -2.0 0.3 ; -2.0 -0.6  ; ...   % outer boundary of mesh 50
    50 NaN ; -2.5 -0.5 ; -2.1 -0.5 ; -2.1 0.1 ; -2.5 0.1 ];       % inner boundary of mesh 50

CtrlVar.GmshMeshingAlgorithm=8;    % see gmsh manual

UserVar=[];
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates); figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)

% also calculate and plot normals
[nx,ny,xn,yn,Nx,Ny] = CalcEdgeAndNodalNormals(MUA.connectivity,MUA.coordinates,MUA.Boundary.Edges);
QuiverColorGHG(MUA.coordinates(MUA.Boundary.Nodes,1),MUA.coordinates(MUA.Boundary.Nodes,2),...
     Nx(MUA.Boundary.Nodes),Ny(MUA.Boundary.Nodes),[]);
 
CtrlVar.MeshBoundaryCoordinates=MeshBoundaryCoordinates;
GmshPointsInLoop=PlotGmshGeometryDefinition(CtrlVar);
 
drawnow

 %str=input('Next example? y/n [y] ? ','s'); if strcmpi(str,'n') ; return ; end

 
%% Example: an elliptical hole/crack
%
% when creating holes within a mesh, separate boundaries by NaN NaN
%
CtrlVar=Ua2D_DefaultParameters(); 
CtrlVar.MeshSizeMax=1e3; 
CtrlVar.MeshSize=1e3;
CtrlVar.MeshSizeMin=0.1e3;


a=0.1e3; % horizontal radius
b=5e3; % vertical radius
x0=0; % x0,y0 ellipse centre coordinates
y0=0;
t=linspace(-pi,pi,200);  t(end)=[];
xe=x0+a*cos(t);
ye=y0+b*sin(t);

CtrlVar.GmshCharacteristicLengthFromCurvature = 1 ;
CtrlVar.GmshCharacteristicLengthExtendFromBoundary=1;


MeshBoundaryCoordinates=...
    [-10e3 -10e3 ; ...
    -10e3 10e3 ; ...
    10e3 10e3 ; ...
    10e3 -10e3 ; ...
    NaN  NaN ; ...
     xe(:) ye(:)] ;

UserVar=[];           
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates); 
figure ;  
PlotFEmesh(MUA.coordinates,MUA.connectivity)
CtrlVar.MeshBoundaryCoordinates=MeshBoundaryCoordinates;
GmshPointsInLoop=PlotGmshGeometryDefinition(CtrlVar);
drawnow
%% Example: Constrainted meshing with two joined meshes sharing the same boundary
%
% Since here the same line belongs to more then one mesh we need to specify
% the 'plane surface' (gmsh terminology) separatly. This is done in CtrlVar.GmshPlaneSurface

CtrlVar=Ua2D_DefaultParameters(); CtrlVar.MeshSizeMax=0.1; CtrlVar.MeshSizeMin=0.1; CtrlVar.MeshSize=0.1;
CtrlVar.MeshGenerator='gmsh';  
CtrlVar.MeshGenerator='mesh2d';  
UserVar=[];
MeshBoundaryCoordinates=[1 NaN ;-1 -1 ; -1 0 ; 0 1 ; 1 0 ; 1 -1 ; 0 -1 ; ...       % Outer boundary (clockwise orientation)
                         1 NaN ;  0.5 -0.5 ; 0.5 0 ; 0.1 0 ; 0.1 -0.5 ; ...         % inner boundary (anticlockwise orientation)
                         1 NaN ; -0.1 -0.5 ; 0 0.3 ; -0.95 0 ; -0.8 -0.9 ];         % another innner boundary (anticlockwise orientation)

CtrlVar.GmshPlaneSurface{1}=[1 2 3]; % mesh 1 is defined by boundaries 1, 2 and 3
CtrlVar.GmshPlaneSurface{2}=[-2];  % mesh 2 is defined by boundary 2, make sure to use a negative sign to indicate a reverse ordering
CtrlVar.GmshPlaneSurface{3}=[-3];  % mesh 2 is defined by boundary 2, make sure to use a negative sign to indicate a reverse ordering
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates); figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)

plot(MeshBoundaryCoordinates(:,1),MeshBoundaryCoordinates(:,2),'-or','LineWidth',2)

drawnow
%str=input('Next example? y/n [y] ? ','s'); if strcmpi(str,'n') ; return ; end

%% Example: two separate meshes in contact


CtrlVar=Ua2D_DefaultParameters(); CtrlVar.MeshSizeMax=0.1; CtrlVar.MeshSizeMin=0.1;  CtrlVar.MeshSize=0.1;
CtrlVar.MeshGenerator='gmsh';  % this option only works with gmsh...
%CtrlVar.MeshGenerator='mesh2d';  
UserVar=[];
MeshBoundaryCoordinates=[1 NaN ;  0 0  ; 0 1 ; 1 1 ; 1 0 ; ...      
                         2 NaN ; -1 0  ; -1 1.001 ; 0 1.001 ; 0 0 ];

[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates); figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)

plot(MeshBoundaryCoordinates(:,1),MeshBoundaryCoordinates(:,2),'-or','LineWidth',2)
drawnow
%str=input('Next example? y/n [y] ? ','s'); if strcmpi(str,'n') ; return ; end

%% Example: Internal boundaries

CtrlVar.MeshGenerator='gmsh';  
CtrlVar.MeshGenerator='mesh2d';  
CtrlVar=Ua2D_DefaultParameters(); CtrlVar.MeshSizeMax=0.1; CtrlVar.MeshSizeMin=0.1;  CtrlVar.MeshSize=0.1;
CtrlVar.GmshInputFormat=1;
UserVar=[];
MeshBoundaryCoordinates=[1 NaN ;  0 0  ; 0 0.25 ; 0.25 0.25 ; 0.25 0.75 ; 0 0.75 ; 0 1 ; 1 1 ; 1 0;   ...      
                         2 NaN ;  0 0.25 ; 0. 0.75 ; 0.25 0.75 ; 0.25 0.25 ];

[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates); 
figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)

plot(MeshBoundaryCoordinates(:,1),MeshBoundaryCoordinates(:,2),'-or','LineWidth',2)
drawnow
%str=input('Next example? y/n [y] ? ','s');  if strcmpi(str,'n') ; return ; end

%% Example: Two subdomains sharing a common boundary.
%
% This example uses GmshInputFormat 2.
% 
% Gmsh input format 2 is quite close to the gmsh input format itself and more
% flexible than the default input format 1, but also more difficult to use.
%
% The gmsh input format 2 does not use `MeshBoundaryCoordinates' at all.
%
% Using gmsh input format 2 allows constraint meshing. The computational domain can be
% split up into several subdomains. each with their own boundaries. One can create
% internal boundaries within a domain, and subdomains sharing some common boundaries.
%
% All inputs are defined as fields to the CtrlVar.
%
% The basic idea is to define points, then to specify lines in terms of those
% points, loops in terms of those lines, and finally plane surfaces in terms of
% the loops.
%
%
CtrlVar=Ua2D_DefaultParameters(); 
UserVar=[];
CtrlVar.MeshGenerator='gmsh';  
CtrlVar.GmshInputFormat=2; % using input format 2
CtrlVar.MeshSizeMax=0.1; 
CtrlVar.MeshSizeMin=0.1;
CtrlVar.MeshSize=0.1;

CtrlVar.Gmsh.Points=[0 0 ;...    % now define a few gmsh points
                     0 0.5 ; ... % although not directly labeled
                     0 1 ;   ... % the first point in point 1, etc. 
                     1 1 ;  ...
                     1 0 ; ... 
                     -1 0 ; ...   % this is point nr 6
                     -1 0.5];     % and this point nr 7

CtrlVar.Gmsh.Lines{1}=[1 , 2];  % define gmsh lines using the point labels
CtrlVar.Gmsh.Lines{2}=[2 , 3];
CtrlVar.Gmsh.Lines{3}=[ 3 ; 4 ; 5 ; 1 ];
CtrlVar.Gmsh.Lines{4}=[ 1 ;  6 ; 7 ; 2 ];

CtrlVar.Gmsh.Loops{1}=[1 ; 2 ; 3 ]; % now define loops
CtrlVar.Gmsh.Loops{2}=[4 ; -1];     % all loops must be closed!
                                    % (negative sign reverses the line direction.)

CtrlVar.Gmsh.PlaneSurfaces{1} = [1]; % finally define the surfaces 
CtrlVar.Gmsh.PlaneSurfaces{2} = [2];

MeshBoundaryCoordinates=[]; % When CtrlVar.GmshInputFormat=2, 'MeshBoundaryCoordinates' are not used
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates); 
figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)
hold on ; PlotGmshGeometryDefinition(CtrlVar);
drawnow
%str=input('Next example? y/n [y] ? ','s');  if strcmpi(str,'n') ; return ; end
%% Example: Several different subdomains
%
% This example uses gmsh input format 2
%
CtrlVar=Ua2D_DefaultParameters(); 
UserVar=[];
MeshBoundaryCoordinates=[];
CtrlVar.MeshGenerator='gmsh';  
CtrlVar.GmshInputFormat=2;
CtrlVar.MeshSizeMax=0.1; CtrlVar.MeshSizeMin=0.1;  CtrlVar.MeshSize=0.1;
CtrlVar.TriNodes=3;

CtrlVar.Gmsh.Points=[0 0 ;...  
                     0 0.5 ; ...
                     0 1 ;   ...
                     1 1 ;  ...
                     1 0 ; ... 
                     -1 0 ; ...
                     -1 0.5 ; ...
                     0.25 0.25 ; ...
                     0.35 0.75 ; ...
                     0.65 0.75 ;
                     0.80 0.25 ;
                     -0.5 1 ; ...
                     -1 2 ; ...
                     1 2 ; ...
                     ];

CtrlVar.Gmsh.Lines{1}=[1 ; 2];
CtrlVar.Gmsh.Lines{2}=[2 ; 3];
CtrlVar.Gmsh.Lines{3}=[ 3 ; 4 ; 5 ; 1 ];
CtrlVar.Gmsh.Lines{4}=[ 1 ;  6 ; 7 ; 2 ];
CtrlVar.Gmsh.Lines{5}=[ 8 ; 9 ; 10 ; 11 ; 8];
CtrlVar.Gmsh.Lines{6}=[ 12 ; 13 ; 14 ; 12];

CtrlVar.Gmsh.Loops{1}=[1 ; 2 ; 3 ];
CtrlVar.Gmsh.Loops{2}=[4 ; -1];
CtrlVar.Gmsh.Loops{3}=[-5]; % reverse orientation 
CtrlVar.Gmsh.Loops{4}=[6];
CtrlVar.Gmsh.Loops{5}=[5];  %

CtrlVar.Gmsh.PlaneSurfaces{1} = [1 ; 3 ]; % this surface has a hole
CtrlVar.Gmsh.PlaneSurfaces{2} = [2];
CtrlVar.Gmsh.PlaneSurfaces{3} = [4];
CtrlVar.Gmsh.PlaneSurfaces{4} = [5];


[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates); 

% plotting mesh
figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)
hold on
PlotGmshGeometryDefinition(CtrlVar);

drawnow
%str=input('Next example? y/n [y] ? ','s');  if strcmpi(str,'n') ; return ; end

%% Example: Meshing the Brunt Ice Shelf
%

load BruntMeshBoundaryCoordinates.mat
UserVar=[];
I=find(isnan(MeshBoundaryCoordinates(:,1)) | isnan(MeshBoundaryCoordinates(:,2)));

i1a=I(1)+1 ; i1b=I(2)-1;  
i2a=I(2)+1 ; i2b=size(MeshBoundaryCoordinates,1);


CtrlVar=Ua2D_DefaultParameters(); 
CtrlVar.MeshGenerator='gmsh';  
CtrlVar.MeshGenerator='mesh2d';  
CtrlVar.GmshInputFormat=2;
CtrlVar.MeshSizeMax=5e3; 
CtrlVar.MeshSizeMin=1e3; 
CtrlVar.TriNodes=3;


CtrlVar.Gmsh.Points=MeshBoundaryCoordinates(i1a:i1b,:);

CtrlVar.Gmsh.Loops{1}=[1];
CtrlVar.Gmsh.PlaneSurfaces{1} = [1];
CtrlVar.Gmsh.Lines{1}=[(1:i1b-i1a+1)';1];
[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates); 


% plotting mesh
figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)
drawnow
%str=input('Next example? y/n [y] ? ','s');  if strcmpi(str,'n') ; return ; end
%%
% Example: Meshing the Brunt Ice Shelf with an internal boundary
load BruntMeshBoundaryCoordinates.mat
CtrlVar.Gmsh.Points=[MeshBoundaryCoordinates(i1a:i1b,:); MeshBoundaryCoordinates(i2a:i2b,:) ];
l1a=1 ; l1b=l1a+i1b-i1a;
l2a=l1b+1 ; l2b=l2a+i2b-i2a;
CtrlVar.Gmsh.Lines{1}=[(l1a:l1b)';l1a];
CtrlVar.Gmsh.Lines{2}=[(l2a:l2b)';l2a];
CtrlVar.Gmsh.Loops{1}=[1];
CtrlVar.Gmsh.Loops{2}=[2];
CtrlVar.Gmsh.PlaneSurfaces{1} = [1,-2];
CtrlVar.Gmsh.PlaneSurfaces{2} = [2];

UserVar=[];

[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates); 
CtrlVar.Gmsh.Lines{1}=[(1:i1b-i1a+1)';1];

% plotting mesh
figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)

hold on ; PlotGmshGeometryDefinition(CtrlVar);
drawnow
%str=input('Next example? y/n [y] ? ','s');  if strcmpi(str,'n') ; return ; end
%% Example: Meshing the Brunt Ice Shelf with an internal boundary and a `fill-in'

load BruntMeshBoundaryCoordinates.mat

I=find(isnan(MeshBoundaryCoordinates(:,1)) | isnan(MeshBoundaryCoordinates(:,2)));

i1a=I(1)+1 ; i1b=I(2)-1;  
i2a=I(2)+1 ; i2b=size(MeshBoundaryCoordinates,1);

UserVar=[];
CtrlVar=Ua2D_DefaultParameters(); 
CtrlVar.GmshInputFormat=2;
CtrlVar.MeshSizeMax=5e3; 
CtrlVar.MeshSizeMin=1e3; 
CtrlVar.TriNodes=3;
CtrlVar.Gmsh.Points=[MeshBoundaryCoordinates(i1a:i1b,:); MeshBoundaryCoordinates(i2a:i2b,:) ];
l1a=1 ; l1b=l1a+i1b-i1a;
l2a=l1b+1 ; l2b=l2a+i2b-i2a;
CtrlVar.Gmsh.Lines{1}=[(l1a:l1b)';l1a];
CtrlVar.Gmsh.Lines{2}=[(l2a:l2b)';l2a];


Box=[-7.02e+05  -6.4314e+05   1.4651e+06   1.505e+06];
I=CtrlVar.Gmsh.Points(:,1) > Box(1) & CtrlVar.Gmsh.Points(:,1) < Box(2) ...
    & CtrlVar.Gmsh.Points(:,2) > Box(3) & CtrlVar.Gmsh.Points(:,2) < Box(4) ;

% now must line 1 into two lines, with one convering the BIS-SW chasm outlines only

x=CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{1},1);
y=CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{1},2);
K=x > Box(1) & x < Box(2) ...
    & y > Box(3) & y < Box(4) ;

temp=CtrlVar.Gmsh.Lines{1};
temp(K)=NaN; temp(end)=[];
J=find(isnan(temp));
tt=[temp(J(end)+1:end,end);temp(1:J(1)-1)];
CtrlVar.Gmsh.Lines{3}=tt;
CtrlVar.Gmsh.Lines{4}=find(K);
CtrlVar.Gmsh.Lines{4}=[CtrlVar.Gmsh.Lines{3}(end); CtrlVar.Gmsh.Lines{4};CtrlVar.Gmsh.Lines{3}(1)];

CtrlVar.Gmsh.Lines{5}=[CtrlVar.Gmsh.Lines{3}(end);CtrlVar.Gmsh.Lines{3}(1)];
CtrlVar.Gmsh.Lines{6}=[CtrlVar.Gmsh.Lines{4}(end);CtrlVar.Gmsh.Lines{4}(1)];

figure 
plot(CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{1},1),CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{1},2),'.-')
hold on
plot(CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{2},1),CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{2},2),'^-')
plot(CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{3},1),CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{3},2),'+-')
hold on
plot(CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{4},1),CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{4},2),'O-')
plot(CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{5},1),CtrlVar.Gmsh.Points(CtrlVar.Gmsh.Lines{5},2),'*-')
legend('1','2','3','4','5')


CtrlVar.Gmsh.Loops{1}=[3,4];
CtrlVar.Gmsh.Loops{2}=[2];
CtrlVar.Gmsh.Loops{3}=[-4,5];

CtrlVar.Gmsh.PlaneSurfaces{1} = [1,-2];
CtrlVar.Gmsh.PlaneSurfaces{2} = [2];
CtrlVar.Gmsh.PlaneSurfaces{3} = [3];


[UserVar,MUA]=genmesh2d(UserVar,CtrlVar,MeshBoundaryCoordinates); 
CtrlVar.Gmsh.Lines{1}=[(1:i1b-i1a+1)';1];

% plotting mesh
figure ;  PlotFEmesh(MUA.coordinates,MUA.connectivity)

hold on ; PlotGmshGeometryDefinition(CtrlVar);
drawnow
%str=input('Next example? y/n [y] ? ','s');  if strcmpi(str,'n') ; return ; end
% %% Example of running gmsh directly for a given input file
% 
% status=system([getenv('GmshHomeDirectory'),'\gmsh.exe GmshFile.geo -2 -v 5']);
% Gmsh=load_gmshGHG('GmshFile.msh'); % the .msh is a gmsh output file. This file must have be generated previously 
% TRI=Gmsh.TRIANGLES(1:Gmsh.nbTriangles,1:3);
% xy=Gmsh.POS(1:Gmsh.nbNod,1:2);
% figure
% triplot(TRI,xy(:,1),xy(:,2)) ; axis equal
% drawnow
% %hold on
% %plot(MeshBoundaryCoordinates(:,1),MeshBoundaryCoordinates(:,2),'-or','LineWidth',2)
% 
% %%
##### SOURCE END #####
--></body></html>